<!DOCTYPE html>
<html lang="zh-TW">
<head>
<link rel="icon" type="image/png" href="./img/favicon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="./img/favicon.png">
<link rel="icon" type="image/png" sizes="96x96" href="./img/favicon.png">
<link rel="apple-touch-icon" href="./img/favicon.png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å“ç¿â™¡ç‘œæ­†å©šå®´åº§ä½æŸ¥è©¢</title>

<style>
  /* ===== å…¨å±€ ===== */
  body {
    font-family: 'Arial', sans-serif;
    margin: 0;
    padding: 20px 15px;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    background: radial-gradient(circle at 20% 30%, #ffd6e9, transparent 60%),
                radial-gradient(circle at 80% 70%, #ffe4f2, transparent 60%),
                #ffeef8;
    color: #333;
    overflow-x: hidden;
  }
  
  /* ===== ç»ç’ƒå¡ç‰‡ Container ===== */
  .container {
    background: rgba(255, 255, 255, 0.45);
    backdrop-filter: blur(12px);
    padding: 25px 25px;
    border-radius: 20px;
    box-shadow: 0 10px 25px rgba(255, 105, 180, 0.3);
    width: 100%;
    max-width: 420px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.6);
    animation: fadeIn 1s ease;
  }
  
  /* ===== æ¨™é¡Œ ===== */
  h1 {
    color: #ff5fa2;
    font-size: 22px;
    margin: 8px 0;
    text-shadow: 0 2px 6px rgba(255, 150, 200, 0.4);
  }
  
  /* ===== è¼¸å…¥æ¡† ===== */
  input[type="text"] {
    width: 82%;
    padding: 12px 15px;
    border-radius: 12px;
    border: 2px solid #ffceeb;
    background: #fff8fc;
    font-size: 16px;
    margin-bottom: 15px;
    box-shadow: inset 0 0 8px rgba(255, 150, 200, 0.2);
    transition: all 0.2s ease;
  }
  input[type="text"]:focus {
    border-color: #ff69b4;
    box-shadow: 0 0 12px rgba(255, 105, 180, 0.4);
    outline: none;
  }
  
  /* ===== æŒ‰éˆ• ===== */
  button {
    background: linear-gradient(135deg, #ff9acb, #ff77a9);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 12px;
    font-size: 16px;
    cursor: pointer;
    width: 90%;
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(255, 120, 180, 0.4);
    transition: transform 0.15s ease, box-shadow 0.2s ease;
  }
  button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 18px rgba(255, 120, 180, 0.55);
  }
  
  /* ===== å¤šé¸æŒ‰éˆ• ===== */
  .option-btn {
    display: block;
    margin: 6px auto;
    background: linear-gradient(135deg, #ffb3cc, #ff8cb4);
    border: none;
    color: white;
    padding: 10px 15px;
    border-radius: 12px;
    width: 80%;
    cursor: pointer;
    box-shadow: 0 3px 10px rgba(255, 100, 180, 0.35);
    transition: transform 0.15s ease, box-shadow 0.2s ease;
  }
  .option-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(255, 100, 180, 0.45);
  }
  
  /* ===== åº§ä½åœ–å®¹å™¨ ===== */
  #imageWrapper {
    width: 100%;
    overflow: hidden;
    border-radius: 16px;
    margin-top: 15px;
    touch-action: none;
    box-shadow: 0 6px 18px rgba(255, 120, 180, 0.35);
  }
  
  /* ===== åº§ä½åœ–æœ¬é«” ===== */
  #seatMap {
    width: 100%;
    height: auto;
    border-radius: 12px;
    transform-origin: center center;
    transition: opacity 0.6s, transform 0.3s;
    /*animation: fadeIn 1.2s ease-out;*/
    opacity: 1;
  }
  
  /* ===== çµæœå€ ===== */
  .result {
    font-size: 18px;
    margin-top: 15px;
    color: #ff4fa0;
    text-shadow: 0 2px 4px rgba(255, 150, 200, 0.4);
  }
  
  /* ===== æ·¡å…¥å‹•ç•« ===== */
  .fade-in {
    opacity: 0;
    animation: fadeIn 0.8s ease-out forwards;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.98); }
    to   { opacity: 1; transform: scale(1); }
  }
  
  /* ===== å¯æ“´å±• Loading å‹•ç•« ===== */
  .loading {
    width: 40px;
    height: 40px;
    border: 4px solid #ffb6c1;
    border-top-color: #ff69b4;
    border-radius: 50%;
    margin: 15px auto;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ===== Header ===== */
  #headerBar {
    position: sticky;
    top: 0;
    z-index: 999;
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(10px);
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 3px 10px rgba(255, 120, 180, 0.2);
  }
  
  #headerBar .title {
    color: #ff4fa0;
    font-size: 18px;
    font-weight: bold;
  }
  
  #headerBar #menuBtn {
    background: #ff77b7;
    border: none;
    padding: 8px 14px;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 3px 8px rgba(255, 120, 180, 0.35);
    transition: transform 0.15s;
  }
  #headerBar #menuBtn:hover {
    transform: scale(1.05);
  }
  
  /* ===== Popup ===== */
  #menuPopup {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }
  
  #menuPopup .popup-content {
    background: white;
    border-radius: 12px;
    padding: 15px;
    max-width: 90%;
    max-height: 90%;
    overflow: auto;
    text-align: center;
  }
  
  #menuPopup img {
    width: 100%;
    height: auto;
    border-radius: 10px;
  }
  
  #closePopup {
    margin-top: 10px;
    padding: 8px 14px;
    border: none;
    background: #ff77b7;
    color: white;
    border-radius: 8px;
    cursor: pointer;
  }


</style>
</head>

<body>
  <!-- ===== Header ===== -->
  <div id="headerBar">
    <span class="title">å©šå®´è³‡è¨Š</span>
    <button id="menuBtn">ğŸ“œ èœå–®</button>
  </div>
  
  <!-- ===== èœå–® Popup ===== -->
  <div id="menuPopup">
    <div class="popup-content">
      <img src="./img/seatnocode.png" alt="å©šå®´èœå–®">
      <button id="closePopup">é—œé–‰</button>
    </div>
  </div>

  <div class="container">
    <h1>å“ç¿â™¡ç‘œæ­†å©šå®´åº§ä½æŸ¥è©¢</h1>
    <h1>ğŸ€</h1>
  
    <input type="text" id="nameInput" placeholder="è«‹è¼¸å…¥åå­—">
    <button id="searchBtn">æŸ¥è©¢åº§ä½</button>
  
    <div class="result" id="result"></div>
  
    <!-- åº§ä½åœ–ï¼ˆé å…ˆé¡¯ç¤ºï¼‰ -->
    <div id="imageWrapper">
      <img id="seatMap" class="fade-in" 
           src="https://sinwoosin31.github.io/1122seatlookup/img/seat.png">
    </div>
  </div>


<script>
  // ========= åŸºæœ¬è¨­å®š =========
  const webAppUrl = "https://script.google.com/macros/s/AKfycbwt4lerkFrFEasl0XjpaiVo9OyKiKcGWMSB-VWiaBjHLhP67M6l3q6teo4YB8vOWPp1/exec";
  const nameInput = document.getElementById("nameInput");
  const resultDiv = document.getElementById("result");
  const wrapper = document.getElementById("imageWrapper");
  const img = document.getElementById("seatMap");

  // ========= å¿«å– =========
  const cache = {};
  const maskCache = {};
  let debounceTimer;

  // ========= å§“åéš±ç¢¼ =========
  function maskNameCached(name) {
      if (maskCache[name]) return maskCache[name];

      const len = name.length;
      let masked;
      if (name.includes("é˜¿")) masked = name;
      else if (len <= 1) masked = name;
      else if (len === 2) masked = name[0] + "*";
      else if (len === 3) masked = name[0] + "*" + name[len - 1];
      else masked = name;

      maskCache[name] = masked;
      return masked;
  }

  // ========= æ¸²æŸ“çµæœ =========
  function renderResult(data) {
      resultDiv.innerHTML = "";
      if (data.seat) {
          resultDiv.innerHTML = `ğŸ€ ${data.name} çš„åº§ä½æ˜¯ ${data.seat} ğŸ€<br>`;
      } else if (data.multiple) {
          resultDiv.textContent = "æ‰¾åˆ°å¤šä½ç¬¦åˆçš„è³“å®¢ï¼Œè«‹é¸æ“‡ï¼š";
          data.multiple.forEach(item => {
              const btn = document.createElement("button");
              btn.className = "option-btn";
              btn.textContent = maskNameCached(item.name);
              btn.onclick = () => {
                  resultDiv.innerHTML = `ğŸ€ ${item.name} çš„åº§ä½æ˜¯ ${item.seat} ğŸ€<br>`;
              };
              resultDiv.appendChild(btn);
          });
      } else {
          resultDiv.textContent = data.error || "æŸ¥ç„¡è³‡æ–™";
      }
  }

  // ========= æŸ¥è©¢ =========
  function searchSeat() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
          const name = nameInput.value.trim();
          if (!name) return resultDiv.textContent = "è«‹è¼¸å…¥åå­—";

          // ==== æ¸…å¿«å– ====
          if (name.toUpperCase() === "æ¸…å¿«å–") {
              fetch(`${webAppUrl}?name=æ¸…å¿«å–`)
                  .then(res => res.json())
                  .then(data => {
                      resultDiv.textContent = data.success || "å¿«å–å·²æ¸…é™¤";
                      Object.keys(cache).forEach(k => delete cache[k]);
                  })
                  .catch(() => {
                      resultDiv.textContent = "æ¸…å¿«å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
                  });
              return;
          }

          if (cache[name]) {
              renderResult(cache[name]);
              return;
          }

          resultDiv.textContent = "æŸ¥è©¢ä¸­...";
          fetch(`${webAppUrl}?name=${encodeURIComponent(name)}`)
              .then(res => res.json())
              .then(data => {
                  cache[name] = data;
                  renderResult(data);
              })
              .catch(() => {
                  resultDiv.textContent = "æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
              });

      }, 250);
  }

  document.getElementById("searchBtn").addEventListener("click", searchSeat);
  nameInput.addEventListener("keypress", e => { if(e.key === "Enter") searchSeat(); });

  // ========= iOS ä¿®æ­£ç‰ˆæ‹–æ›³ç¸®æ”¾ =========

  let scale = 1, lastScale = 1;
  let posX = 0, posY = 0;
  let lastX = 0, lastY = 0;
  let startDistance = 0;
  let ticking = false;

  wrapper.addEventListener("touchstart", (e) => {
      if (e.touches.length === 2) {
          startDistance = getDistance(e.touches[0], e.touches[1]);
      } else if (e.touches.length === 1) {
          lastX = e.touches[0].clientX - posX;
          lastY = e.touches[0].clientY - posY;
      }
  }, { passive: false });

  wrapper.addEventListener("touchmove", (e) => {
      if (scale > 1) e.preventDefault();   // iOS å®‰å…¨ï¼šåƒ…é™æ”¾å¤§æ™‚é˜»æ­¢é è¨­
      else return;                         // æœªæ”¾å¤§æ™‚é¿å…ç™½ç•«é¢

      if (e.touches.length === 2) {
          const newDist = getDistance(e.touches[0], e.touches[1]);
          scale = Math.min(Math.max(lastScale * (newDist / startDistance), 1), 3);
          requestUpdate();
      }

      if (e.touches.length === 1 && scale > 1) {
          posX = e.touches[0].clientX - lastX;
          posY = e.touches[0].clientY - lastY;
          requestUpdate();
      }
  }, { passive: false });

  wrapper.addEventListener("touchend", () => {
      lastScale = scale;

      // é˜²æ­¢æ‹–å‡ºç•«é¢é€ æˆç™½å€å¡Š
      clampPosition();
      requestUpdate();
  });

  function getDistance(a, b) {
      return Math.hypot(a.clientX - b.clientX, a.clientY - b.clientY);
  }

  function clampPosition() {
      const maxX = (img.clientWidth * scale - wrapper.clientWidth) / 2;
      const maxY = (img.clientHeight * scale - wrapper.clientHeight) / 2;

      posX = Math.min(Math.max(posX, -maxX), maxX);
      posY = Math.min(Math.max(posY, -maxY), maxY);
  }

  function requestUpdate() {
      if (!ticking) {
          requestAnimationFrame(() => {
              img.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
              ticking = false;
          });
          ticking = true;
      }
  }
  
  // ===== Popup é–‹é—œæ§åˆ¶ =====
  document.getElementById("menuBtn").onclick = function () {
    document.getElementById("menuPopup").style.display = "flex";
  };
  
  document.getElementById("closePopup").onclick = function () {
    document.getElementById("menuPopup").style.display = "none";
  };
  
  // é» popup èƒŒæ™¯ä¹Ÿæœƒé—œé–‰
  document.getElementById("menuPopup").onclick = function (e) {
    if (e.target === this) this.style.display = "none";
  };

</script>


</body>
</html>
